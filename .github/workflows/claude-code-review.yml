name: Claude Code Review & Auto-Approval

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, dismissed]
  pull_request_review_comment:
    types: [created, deleted]
  issue_comment:
    types: [created, deleted]

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write
  actions: read

jobs:
  # Job 1: Claude automatically reviews the code
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      (github.event_name == 'pull_request' &&
       contains(fromJSON('["opened", "synchronize", "reopened", "ready_for_review"]'), github.event.action))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}'

  # Job 2: Build check and auto-approval
  build-and-approve:
    name: Build & Auto-Approve
    runs-on: macos-latest
    # Wait for Claude review to complete first (if it ran)
    needs: [claude-review]
    # Continue even if Claude review is skipped, but only for non-draft PRs
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build project
        id: build
        run: |
          xcodebuild -scheme DHBootlegToolkit -configuration Debug build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee build.log

          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "build_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check for unresolved comments
        id: check_comments
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Get unresolved review threads count
          UNRESOLVED=$(gh pr view $PR_NUMBER --json reviewThreads --jq '[.reviewThreads[] | select(.isResolved == false)] | length')

          echo "unresolved_count=$UNRESOLVED" >> $GITHUB_OUTPUT

          if [ "$UNRESOLVED" -eq 0 ]; then
            echo "No unresolved comments found ‚úÖ"
          else
            echo "Found $UNRESOLVED unresolved comment(s) ‚è≥"
          fi

      - name: Check existing approvals
        id: check_approvals
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Check if this bot has already approved
          BOT_APPROVED=$(gh pr view $PR_NUMBER --json reviews --jq '[.reviews[] | select(.author.login == "github-actions[bot]" and .state == "APPROVED")] | length')

          echo "bot_approved=$BOT_APPROVED" >> $GITHUB_OUTPUT

          if [ "$BOT_APPROVED" -gt 0 ]; then
            echo "Already approved by GitHub Actions ‚úÖ"
          fi

      - name: Auto-approve PR
        if: |
          success() &&
          steps.build.outputs.build_status == 'success' &&
          steps.check_comments.outputs.unresolved_count == '0' &&
          steps.check_approvals.outputs.bot_approved == '0'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          gh pr review $PR_NUMBER --approve --body "‚úÖ **Auto-approved by GitHub Actions**

          All checks passed:
          - Build successful
          - All review comments resolved
          - No blocking issues found

          This PR is ready to merge!"

      - name: Comment on blocking issues
        if: |
          success() &&
          (steps.build.outputs.build_status == 'failed' ||
           steps.check_comments.outputs.unresolved_count != '0')
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          UNRESOLVED=${{ steps.check_comments.outputs.unresolved_count }}
          BUILD_STATUS=${{ steps.build.outputs.build_status }}

          COMMENT="‚è≥ **Auto-approval pending**

          This PR cannot be auto-approved yet due to:
          "

          if [ "$BUILD_STATUS" == "failed" ]; then
            COMMENT="$COMMENT
          - ‚ùå Build failed - please fix build errors"
          fi

          if [ "$UNRESOLVED" != "0" ]; then
            COMMENT="$COMMENT
          - üí¨ $UNRESOLVED unresolved review comment(s) - please resolve all discussions"
          fi

          COMMENT="$COMMENT

          Once all issues are resolved, this PR will be automatically approved."

          gh pr comment $PR_NUMBER --body "$COMMENT"

      - name: Upload build log on failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
