name: Claude Code Review & Auto-Approval

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, dismissed]
  pull_request_review_comment:
    types: [created, deleted]
  issue_comment:
    types: [created, deleted]

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write
  actions: read

jobs:
  # Job 1: Claude automatically reviews the code
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      (github.event_name == 'pull_request' &&
       contains(fromJSON('["opened", "synchronize", "reopened", "ready_for_review"]'), github.event.action))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Cache Claude Code
        id: cache-claude
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/claude
          key: claude-code-${{ runner.os }}-v2.1.25
          restore-keys: |
            claude-code-${{ runner.os }}-

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}'
          path_to_claude_code_executable: ${{ steps.cache-claude.outputs.cache-hit == 'true' && '~/.local/bin/claude' || '' }}

      - name: Post Review Summary
        if: always() && steps.claude-review.outcome != 'skipped'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Get PR metadata
          PR_INFO=$(gh pr view $PR_NUMBER --json files,additions,deletions,changedFiles)
          FILES_CHANGED=$(echo "$PR_INFO" | jq -r '.changedFiles')
          ADDITIONS=$(echo "$PR_INFO" | jq -r '.additions')
          DELETIONS=$(echo "$PR_INFO" | jq -r '.deletions')

          # Get list of changed files (first 10)
          FILE_LIST=$(echo "$PR_INFO" | jq -r '.files[:10] | map("  - `" + .path + "`") | join("\n")')
          MORE_FILES=$(echo "$PR_INFO" | jq -r 'if (.files | length) > 10 then "  - ... and " + ((.files | length) - 10 | tostring) + " more files" else "" end')

          # Determine status based on step outcome
          if [ "${{ steps.claude-review.outcome }}" == "success" ]; then
            STATUS="‚úÖ Completed Successfully"
            RESULT="‚úÖ **No high-confidence issues found**

          This PR meets the project's quality standards based on automated analysis. The absence of reported issues means:
          - No obvious bugs detected in the changes
          - Code follows CLAUDE.md guidelines
          - No historical context issues identified
          - No recurring problems from previous PRs"
          else
            STATUS="‚ö†Ô∏è Completed with Issues"
            RESULT="‚ö†Ô∏è **Issues detected - please review**

          The review found high-confidence issues that should be addressed. Check the comments above for specific details."
          fi

          # Post comprehensive summary
          gh pr comment $PR_NUMBER --body "## ü§ñ Claude Code Review Summary

          **Review Status:** $STATUS

          ### What Was Checked
          - ‚úÖ **CLAUDE.md Compliance** - Verified adherence to project coding guidelines
          - ‚úÖ **Bug Patterns** - Scanned for memory leaks, null dereferences, logic errors
          - ‚úÖ **Historical Context** - Analyzed git blame for potential breaking changes
          - ‚úÖ **Previous PR Feedback** - Checked for recurring issues in modified files
          - ‚úÖ **Code Comment Compliance** - Ensured changes match documented behavior

          ### Review Scope
          - **Files reviewed:** $FILES_CHANGED files
          - **Lines changed:** +$ADDITIONS / -$DELETIONS

          <details>
          <summary>üìÅ Files reviewed (click to expand)</summary>

          $FILE_LIST
          $MORE_FILES
          </details>

          ### Review Process
          - **Agents:** 5 independent Sonnet agents (parallel review)
          - **Confidence threshold:** ‚â•80% (only high-confidence issues reported)
          - **False positive filtering:** Aggressive (to avoid noise)

          ### Result
          $RESULT

          ---
          *Note: This is an automated review. Human review is still valuable for architectural decisions, UX considerations, and business logic validation.*"

      - name: Comment on Review Failure
        if: failure() && steps.claude-review.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## ‚ö†Ô∏è Claude Code Review Failed

          The automated code review encountered an error and could not complete.

          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          This may be due to:
          - Claude API rate limits or authentication issues
          - Plugin installation or execution errors
          - Network connectivity problems

          A manual review is recommended."

  # Job 2: Build check and auto-approval
  build-and-approve:
    name: Build & Auto-Approve
    runs-on: macos-latest
    # Wait for Claude review to complete first (if it ran)
    needs: [claude-review]
    # Continue even if Claude review is skipped, but only for non-draft PRs
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build project
        id: build
        run: |
          xcodebuild -scheme DHBootlegToolkit -configuration Debug build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee build.log

          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "build_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check for unresolved comments
        id: check_comments
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Check review decision (APPROVED, CHANGES_REQUESTED, REVIEW_REQUIRED)
          REVIEW_DECISION=$(gh pr view $PR_NUMBER --json reviewDecision --jq '.reviewDecision // "REVIEW_REQUIRED"')

          echo "Review decision: $REVIEW_DECISION"

          # Count blocking reviews (changes requested)
          CHANGES_REQUESTED=$(gh pr view $PR_NUMBER --json reviews --jq '[.reviews[] | select(.state == "CHANGES_REQUESTED")] | length')

          echo "unresolved_count=$CHANGES_REQUESTED" >> $GITHUB_OUTPUT
          echo "review_decision=$REVIEW_DECISION" >> $GITHUB_OUTPUT

          if [ "$CHANGES_REQUESTED" -eq 0 ]; then
            echo "No blocking reviews found ‚úÖ"
          else
            echo "Found $CHANGES_REQUESTED review(s) requesting changes ‚è≥"
          fi

      - name: Check existing approvals
        id: check_approvals
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Check if this bot has already approved
          BOT_APPROVED=$(gh pr view $PR_NUMBER --json reviews --jq '[.reviews[] | select(.author.login == "github-actions[bot]" and .state == "APPROVED")] | length')

          echo "bot_approved=$BOT_APPROVED" >> $GITHUB_OUTPUT

          if [ "$BOT_APPROVED" -gt 0 ]; then
            echo "Already approved by GitHub Actions ‚úÖ"
          fi

      - name: Auto-approve PR
        if: |
          success() &&
          steps.build.outputs.build_status == 'success' &&
          steps.check_comments.outputs.unresolved_count == '0' &&
          steps.check_approvals.outputs.bot_approved == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          gh pr review $PR_NUMBER --approve --body "‚úÖ **Auto-approved by GitHub Actions**

          All checks passed:
          - Build successful
          - All review comments resolved
          - No blocking issues found

          This PR is ready to merge!"

      - name: Comment on blocking issues
        if: |
          success() &&
          (steps.build.outputs.build_status == 'failed' ||
           steps.check_comments.outputs.unresolved_count != '0')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CHANGES_REQUESTED=${{ steps.check_comments.outputs.unresolved_count }}
          BUILD_STATUS=${{ steps.build.outputs.build_status }}

          COMMENT="‚è≥ **Auto-approval pending**

          This PR cannot be auto-approved yet due to:
          "

          if [ "$BUILD_STATUS" == "failed" ]; then
            COMMENT="$COMMENT
          - ‚ùå Build failed - please fix build errors"
          fi

          if [ "$CHANGES_REQUESTED" != "0" ]; then
            COMMENT="$COMMENT
          - üí¨ $CHANGES_REQUESTED review(s) requesting changes - please address the feedback"
          fi

          COMMENT="$COMMENT

          Once all issues are resolved, this PR will be automatically approved."

          gh pr comment $PR_NUMBER --body "$COMMENT"

      - name: Upload build log on failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
