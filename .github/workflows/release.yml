name: Release

on:
  release:
    types: [published]

jobs:
  build:
    name: Build and Package
    runs-on: macos-26
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build app
        run: |
          xcodebuild \
            -scheme DHBootlegToolkit \
            -configuration Release \
            -derivedDataPath ./build \
            MARKETING_VERSION=${{ steps.version.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ github.run_number }} \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

      - name: Locate built app
        id: app
        run: |
          APP_PATH=$(find build -name "DHBootlegToolkit.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Could not find DHBootlegToolkit.app"
            exit 1
          fi
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "‚úÖ Found app at: $APP_PATH"

      - name: Verify app version
        run: |
          BUILT_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "${{ steps.app.outputs.app_path }}/Contents/Info.plist")
          echo "‚úÖ Built version: $BUILT_VERSION"
          if [ "$BUILT_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "‚ùå Version mismatch! Expected ${{ steps.version.outputs.version }}, got $BUILT_VERSION"
            exit 1
          fi

      - name: Create zip file
        id: zip
        run: |
          mkdir -p releases
          ditto -c -k --keepParent "${{ steps.app.outputs.app_path }}" "releases/DHBootlegToolkit-${{ steps.version.outputs.version }}.zip"
          ZIP_FILE="DHBootlegToolkit-${{ steps.version.outputs.version }}.zip"
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "zip_path=releases/$ZIP_FILE" >> $GITHUB_OUTPUT

          SIZE=$(du -h "releases/$ZIP_FILE" | awk '{print $1}')
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "üì¶ Created: $ZIP_FILE ($SIZE)"

      - name: Calculate SHA256
        id: sha
        run: |
          cd releases
          SHA=$(shasum -a 256 "${{ steps.zip.outputs.zip_file }}" | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "üîê SHA256: $SHA"

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.version.outputs.version }} \
            ${{ steps.zip.outputs.zip_path }} \
            --clobber
          echo "‚úÖ Uploaded to release ${{ steps.version.outputs.version }}"

    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.sha.outputs.sha256 }}
      zip_file: ${{ steps.zip.outputs.zip_file }}

  sync-version:
    name: Sync Version to Repository
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Update project.yml
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "üìù Updating MARKETING_VERSION to $VERSION"

          # Update MARKETING_VERSION in project.yml
          sed -i "s/MARKETING_VERSION: .*/MARKETING_VERSION: $VERSION/" project.yml

          # Verify the change
          grep "MARKETING_VERSION" project.yml

      - name: Commit and push version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add project.yml

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚úÖ No version changes needed (already up to date)"
          else
            git commit -m "chore: bump version to ${{ needs.build.outputs.version }} [skip ci]"
            git push origin master
            echo "‚úÖ Version synced to repository"
          fi

  update-homebrew:
    name: Update Homebrew Cask
    needs: build
    runs-on: macos-latest

    steps:
      - name: Verify HOMEBREW_TAP_TOKEN
        run: |
          if [ -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]; then
            echo "‚ùå ERROR: HOMEBREW_TAP_TOKEN secret is not set or is empty"
            echo "Please set the secret at: https://github.com/lRoMYl/DHBootlegToolkit/settings/secrets/actions"
            exit 1
          fi

          TOKEN="${{ secrets.HOMEBREW_TAP_TOKEN }}"
          if [[ ! "$TOKEN" =~ ^github_pat_ ]]; then
            echo "‚ö†Ô∏è  WARNING: Token doesn't start with 'github_pat_' (expected for fine-grained tokens)"
            echo "If using a classic token, this is normal (starts with 'ghp_')"
          else
            echo "‚úÖ Token appears to be a valid fine-grained token"
          fi

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: lRoMYl/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update cask file
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          SHA256="${{ needs.build.outputs.sha256 }}"
          CASK_FILE="homebrew-tap/Casks/dhbootlegtoolkit.rb"

          if [ ! -f "$CASK_FILE" ]; then
            echo "‚ùå Cask file not found: $CASK_FILE"
            exit 1
          fi

          # Update version
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" "$CASK_FILE"

          # Update sha256
          sed -i '' "s/sha256 \".*\"/sha256 \"$SHA256\"/" "$CASK_FILE"

          echo "‚úÖ Updated cask file:"
          grep -E "(version|sha256)" "$CASK_FILE"

      - name: Commit and push cask update
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Casks/dhbootlegtoolkit.rb

          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit (already up to date)"
          else
            git commit -m "dhbootlegtoolkit ${{ needs.build.outputs.version }}"
            git push
            echo "‚úÖ Homebrew cask updated to ${{ needs.build.outputs.version }}"
          fi
