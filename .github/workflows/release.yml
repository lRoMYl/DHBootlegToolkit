name: Release

on:
  release:
    types: [published]
  push:
    tags:
      - '*'

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build app
        run: |
          xcodebuild \
            -scheme DHBootlegToolkit \
            -configuration Release \
            -derivedDataPath ./build \
            MARKETING_VERSION=${{ steps.version.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ github.run_number }} \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

      - name: Locate built app
        id: app
        run: |
          APP_PATH=$(find build -name "DHBootlegToolkit.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Could not find DHBootlegToolkit.app"
            exit 1
          fi
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "‚úÖ Found app at: $APP_PATH"

      - name: Verify app version
        run: |
          BUILT_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "${{ steps.app.outputs.app_path }}/Contents/Info.plist")
          echo "‚úÖ Built version: $BUILT_VERSION"
          if [ "$BUILT_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "‚ùå Version mismatch! Expected ${{ steps.version.outputs.version }}, got $BUILT_VERSION"
            exit 1
          fi

      - name: Create zip file
        id: zip
        run: |
          mkdir -p releases
          cd releases
          ditto -c -k --keepParent "${{ steps.app.outputs.app_path }}" "DHBootlegToolkit-${{ steps.version.outputs.version }}.zip"
          ZIP_FILE="DHBootlegToolkit-${{ steps.version.outputs.version }}.zip"
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "zip_path=releases/$ZIP_FILE" >> $GITHUB_OUTPUT

          SIZE=$(du -h "$ZIP_FILE" | awk '{print $1}')
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "üì¶ Created: $ZIP_FILE ($SIZE)"

      - name: Calculate SHA256
        id: sha
        run: |
          cd releases
          SHA=$(shasum -a 256 "${{ steps.zip.outputs.zip_file }}" | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "üîê SHA256: $SHA"

      - name: Upload to release
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.version.outputs.version }} \
            ${{ steps.zip.outputs.zip_path }} \
            --clobber
          echo "‚úÖ Uploaded to release ${{ steps.version.outputs.version }}"

      - name: Create release if from tag push
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.version.outputs.version }} \
            ${{ steps.zip.outputs.zip_path }} \
            --title "DHBootlegToolkit ${{ steps.version.outputs.version }}" \
            --notes "Release ${{ steps.version.outputs.version }}"
          echo "‚úÖ Created release ${{ steps.version.outputs.version }}"

    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.sha.outputs.sha256 }}
      zip_file: ${{ steps.zip.outputs.zip_file }}

  sync-version:
    name: Sync Version to Repository
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update project.yml
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "üìù Updating MARKETING_VERSION to $VERSION"

          # Update MARKETING_VERSION in project.yml
          sed -i "s/MARKETING_VERSION: .*/MARKETING_VERSION: $VERSION/" project.yml

          # Verify the change
          grep "MARKETING_VERSION" project.yml

      - name: Commit and push version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add project.yml

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚úÖ No version changes needed (already up to date)"
          else
            git commit -m "chore: bump version to ${{ needs.build.outputs.version }} [skip ci]"
            git push origin main
            echo "‚úÖ Version synced to repository"
          fi

  update-homebrew:
    name: Update Homebrew Cask
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Update Homebrew cask
        uses: macauley/action-homebrew-bump-cask@v1
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          tap: lRoMYl/homebrew-tap
          cask: dhbootlegtoolkit
          livecheck: false
          dryrun: false
        continue-on-error: true

      - name: Manual Homebrew update fallback
        if: failure()
        run: |
          echo "‚ö†Ô∏è  Automated Homebrew update failed"
          echo "üìù Manual update required:"
          echo ""
          echo "Update homebrew-tap/Casks/dhbootlegtoolkit.rb:"
          echo "  version \"${{ needs.build.outputs.version }}\""
          echo "  sha256 \"${{ needs.build.outputs.sha256 }}\""
          echo ""
          echo "Download URL:"
          echo "  https://github.com/${{ github.repository }}/releases/download/${{ needs.build.outputs.version }}/${{ needs.build.outputs.zip_file }}"
